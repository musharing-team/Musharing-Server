<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta name="description" content="Musharing Admin">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Musharing Admin</title>

    <!-- å›¾æ ‡ -->
    <link rel="stylesheet" href="/static/css/iconfont.css">
    <!-- Vue.js -->
    <!-- TODO éƒ¨ç½²å‰æ”¹ä¸ºä½¿ç”¨ç”Ÿäº§ç¯å¢ƒ -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- Bootstrap @3.3.7 -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <!-- axios v0.12.0 -->
    <script src="/static/js/axios.min.js"></script>

    <link rel="stylesheet" href="/static/css/style.default.css" id="theme-stylesheet">

    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <!-- header -->
    <header class="header" id="header">
        <nav class="navbar navbar-expand-lg px-4 bg-white shadow">
            <h1 class=" font-weight-bold text-uppercase ">Musharing Admin</h1>
        </nav>
    </header>

    <div id="main">
        <div class="row" id="content">
            <!-- login -->
            <div class="col-xs-12 col-sm-3 col-md-3" id="left-side">
                <h2>ç®¡ç†å‘˜èº«ä»½</h2>
                <p>è¯·ç”¨æ‚¨çš„ç®¡ç†å‘˜èº«ä»½ç™»å½•Musharing Admin:</p>
                <div class="form-group">
                    <label for="exampleInputEmail1">ç®¡ç†å‘˜ç”¨æˆ·å</label>
                    <input type="text" v-model="name" class="form-control" id="name" placeholder="Administrator">
                </div>
                <div class="form-group">
                    <label for="exampleInputPassword1">ç®¡ç†å‘˜å¯†ç </label>
                    <input type="password" v-model="password" class="form-control" id="password" placeholder="Password">
                </div>

                <div>
                    <div class="text-center">
                        <button @click="login" class="btn btn-default" type="submit">ç™»å½•</button>
                    </div>
                </div>

                <div v-if="loginInfoShow" class="alert alert-info alert-dismissible" role="alert">
                    <button @click="loginInfoShow = false" type="button" class="close" data-dismiss="alert"
                        aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <strong>æ¬¢è¿æ‚¨ {{ name }}!</strong> <br />å·²è®°å½•æ‚¨çš„èº«ä»½ï¼Œæ‚¨çš„ç®¡ç†å‘˜æƒé™å°†åœ¨æ‚¨è¯•å›¾æŸ¥çœ‹æ•°æ®æˆ–æäº¤æ“ä½œæ—¶è¢«éªŒè¯ã€‚
                </div>

                <div v-if="loginWarningShow" class="alert alert-danger alert-dismissible" role="alert">
                    <button @click="loginWarningShow = false" type="button" class="close" data-dismiss="alert"
                        aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <strong>è­¦å‘Š!</strong> <br />è¯·æ­£ç¡®è¾“å…¥ç”¨æˆ·åã€å¯†ç ã€‚
                </div>

            </div>

            <!-- content -->
            <div class="col-xs-12 col-sm-8 col-md-8" id="right-side">
                <!-- nav -->
                <nav>
                    <ul class="nav nav-tabs">
                        <content-nav-item v-for="(description, id) in contentNav" :id="id" :description="description"
                            :active="id === currentActiveNav ? 'active': ''" :click="switchNav" :key="id">
                        </content-nav-item>
                        <!-- <li id="current" role="presentation" class="active"><a href="#">å½“å‰</a></li>
                                <li id="notice" role="presentation"><a href="#">é€šçŸ¥</a></li> -->

                        <!-- <li role="presentation"><a href="#">...</a></li> -->
                    </ul>
                </nav>
                <!-- main content -->
                <div class="bg-white shadow" id="main-content">
                    <!-- current -->
                    <div v-if="currentActiveNav === 'current'">
                        <div>
                            <div class="text-right">
                                <button @click="getStatus" class="btn btn-default" type="submit">è·å–å½“å‰çŠ¶æ€</button>
                            </div>
                        </div>
                        <div v-if="statusErrorShow" class="alert alert-warning alert-dismissible" role="alert">
                            <button @click="statusErrorShow = false" type="button" class="close" data-dismiss="alert"
                                aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <strong>çŠ¶æ€è·å–å¤±è´¥!</strong> <br />{{ statusErrorText }}
                        </div>
                        <div>
                            <div class="row status-pad">
                                <!-- All User -->
                                <div class="col-xs-2 col-sm-2 col-md-2 status-block shadow">
                                    <div>
                                        <span class="status-icon iconfont icon-users"></span>
                                        <span class="status-title">Total Users</span>
                                        <span class="status-num">{{ status_nums.user_num }}</span>
                                    </div>
                                </div>
                                <!-- Login User -->
                                <div class="col-xs-2 col-sm-2 col-md-2 status-block shadow">
                                    <div>
                                        <span class="status-icon iconfont icon-login_user"></span>
                                        <span class="status-title">Login Users</span>
                                        <span class="status-num">{{ status_nums.login_num }}</span>
                                    </div>
                                </div>
                                <!-- Inroom User -->
                                <div class="col-xs-2 col-sm-2 col-md-2 status-block shadow">
                                    <div>
                                        <span class="status-icon iconfont icon-Users"
                                            style="font-size:30px !important; top: -5%;"></span>
                                        <span class="status-title">InRoom Users</span>
                                        <span class="status-num">{{ status_nums.inroom_num }}</span>
                                    </div>
                                </div>
                                <!-- Rooms -->
                                <div class="col-xs-2 col-sm-2 col-md-2 status-block shadow">
                                    <div>
                                        <span class="status-icon iconfont icon-iconroom"></span>
                                        <span class="status-title">Rooms</span>
                                        <span class="status-num">{{ status_nums.rooms_num }}</span>
                                    </div>
                                </div>
                                <!-- Playlists -->
                                <div class="col-xs-2 col-sm-2 col-md-2 status-block shadow">
                                    <div>
                                        <span class="status-icon iconfont icon-playlist"></span>
                                        <span class="status-title">Playlists</span>
                                        <span class="status-num">{{ status_nums.playlist_num }}</span>
                                    </div>
                                </div>
                                <!-- Notices -->
                                <div class="col-xs-2 col-sm-2 col-md-2 status-block shadow">
                                    <div>
                                        <span class="status-icon iconfont icon-notice"></span>
                                        <span class="status-title">Notices</span>
                                        <span class="status-num">{{ status_nums.notice_num }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <!-- notice-post -->
                    <div v-if="currentActiveNav === 'notice-post'">
                        <div class="form-group">
                            <label for="title">æ ‡é¢˜</label>
                            <input v-model="notice.title" type="text" name="title" class="form-control" id="title"
                                placeholder="å¿…é¡»è¾“å…¥é€šçŸ¥æ ‡é¢˜ï¼">
                        </div>
                        <div class="form-group">
                            <label for="text">å†…å®¹</label>
                            <textarea v-model="notice.content" name="content" class="form-control" id="content"
                                rows="10" placeholder="è¾“å…¥é€šçŸ¥æ–‡æœ¬å†…å®¹"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="text">è¿‡æœŸæ—¶é—´</label>
                            <input v-model="notice.expired" type="datetime-local" name="expired" class="form-control"
                                id="expired" placeholder="è¿‡æœŸæ—¶é—´"></input>
                        </div>
                        <div class="form-group">
                            <label for="text">æŒ‡å®šæ¥æ”¶ç”¨æˆ·</label>
                            <textarea v-model="notice.audience" name="audience" class="form-control" id="audience"
                                placeholder='æ¥æ”¶ç”¨æˆ· uid åˆ—è¡¨ï¼Œjsonæ ¼å¼ï¼Œä¾‹å¦‚ ["001", "003", "023"]'></textarea>
                        </div>
                        <div id="submit-notice">

                            <div class="text-right">
                                <input v-model="noticeChecked" type="checkbox">
                                ç¡®è®¤æ‰€æœ‰ä¿¡æ¯æ— è¯¯ï¼
                                <button @click="postNotice" class="btn btn-default" type="submit">å‘å¸ƒ</button>
                            </div>

                            <div v-if="noticeErrorShow" class="alert alert-danger alert-dismissible" role="alert">
                                <button @click="noticeErrorShow = false" type="button" class="close"
                                    data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <strong>å‘å¸ƒå¤±è´¥!</strong> <br />{{ noticeErrorText }}
                            </div>
                            <div v-if="noticeSuccessShow" class="alert alert-success alert-dismissible" role="alert">
                                <button @click="noticeSuccessShow = false" type="button" class="close"
                                    data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <strong>å‘å¸ƒæˆåŠŸ!</strong> <br />é€šçŸ¥å·²å‘å¸ƒã€‚
                            </div>
                        </div>
                    </div>

                    <div v-if="currentActiveNav === 'more'">
                        <div style="margin: 50px">
                            è¿™é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰ğŸ¤ª
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <footer class="navbar navbar-default navbar-fixed-bottom">
        <div class="row">
            <div class="col-xs-12 col-sm-3 col-md-3" id="copyright">
                Copyright Â© 2019 Musharing Team. All rights reserved.
            </div>
            <!-- <div class="col-xs-12 col-sm-3 col-md-3" id="quicklink">
                å¿«é€Ÿé“¾æ¥ï¼š
                <ul>
                    <li><a>github: Musharing-Android</a></li>
                    <li><a>github: Musharing-Sever</a></li>
                </ul>
            </div> -->
            <div class="col-xs-12 col-sm-3 col-md-3" id="totop" style="float: right">
                <a href="#header">To the Top</a>
            </div>
        </div>
    </footer>
</body>



<script type="text/javascript">

    var contentNav = {
        "current": "å½“å‰",
        "notice-post": "å‘å¸ƒé€šçŸ¥",
        "more": "æ›´å¤š"
    }

    const DEFAULT_NOTICE_ERROR_TEXT = 'é€šçŸ¥å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¡®ä¿å„é¡¹å¡«å†™æ­£ç¡®ï¼Œå¹¶å‹¾é€‰â€œç¡®è®¤æ‰€æœ‰ä¿¡æ¯æ— è¯¯â€åé‡è¯•ï¼Œè‹¥é—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·è”ç³»æƒé™æ›´é«˜çš„ç®¡ç†å‘˜ã€‚'
    const DEFAULT_STATUS_ERROR_TEXT = 'è¯·æ­£ç¡®ç™»å½•åç‚¹å‡»â€œè·å–å½“å‰çŠ¶æ€â€é‡è¯•ã€‚'

    Vue.component("content-nav-item", {
        props: ['id', 'description', 'active', 'click'],
        template: '<li :id="id" role="presentation" :class="active" class="nav-card" @click="click(id)"><a>{{ description }}</a></li>'
    })

    var notice = {
        "title": "",
        "content": "",
        "expired": "",
        "audience": ""
    }

    var status_nums = {
        "user_num": "-",
        "login_num": "-",
        "inroom_num": "-",
        "rooms_num": "-",
        "playlist_num": "-",
        "notice_num": "-"
    }

    var mainVm = new Vue({
        el: "#main",
        data: {
            name: "",
            password: "",
            loginInfoShow: false,
            loginWarningShow: false,

            currentActiveNav: "current",
            contentNav: contentNav,

            status_nums: status_nums,
            statusErrorShow: true,
            statusErrorText: DEFAULT_STATUS_ERROR_TEXT,

            notice: notice,
            noticeChecked: false,
            noticeErrorShow: false,
            noticeSuccessShow: false,
            noticeErrorText: DEFAULT_NOTICE_ERROR_TEXT
        },
        computed: {
            legalNotice: function () {
                return ((this.notice.title != "") || (this.notice.content != ""))
            }
        },
        methods: {
            switchNav: function (id) {
                this.currentActiveNav = id
            },
            login: function () {
                if (this.name != "" && this.password != "") {
                    this.loginWarningShow = false
                    this.loginInfoShow = true
                } else {
                    this.loginInfoShow = false
                    this.loginWarningShow = true
                }
            },
            getStatus: function () {
                var vm = this

                // é…ç½® axios ä½¿ç”¨ form
                axios.defaults.headers.post['Content-Type'] = 'Content-Type:application/x-www-form-urlencoded; charset=UTF-8'

                var params = new URLSearchParams();
                params.append('name', this.name);
                params.append('password', this.password);

                axios.post('/status', params).then(function (response) {
                    if (response.data.response != undefined) {
                        if (response.data.response.status != undefined) {  // è·å–æˆåŠŸ
                            let sts = response.data.response.status
                            for (var k in sts) {
                                Vue.set(vm.status_nums, k, sts[k])
                            }
                            vm.statusErrorShow = false
                            return
                        }
                    } else if (response.data.error != undefined) {
                        switch (response.data.error.error) {
                            case "not_permitted":
                                vm.statusErrorText = "ç®¡ç†å‘˜æƒé™è®¤è¯æœªé€šè¿‡ï¼Œè¯·æ­£ç¡®å¡«å†™æ‚¨çš„ç®¡ç†å‘˜ç”¨æˆ·ååŠå¯†ç "
                                break
                            default:
                                vm.statusErrorText = DEFAULT_STATUS_ERROR_TEXT
                        }
                        vm.statusErrorShow = true
                    }
                });
            },
            postNotice: function () {
                if (!this.noticeChecked || !this.legalNotice) {
                    this.noticeSuccessShow = false
                    this.noticeErrorText = "è¯·ç¡®ä¿å®Œæ•´å¡«å†™å„é¡¹ä¿¡æ¯ï¼Œå¹¶å‹¾é€‰â€œç¡®è®¤æ‰€æœ‰ä¿¡æ¯æ— è¯¯â€ã€‚"
                    this.noticeErrorShow = true
                    return
                } else {
                    this.noticeSuccessShow = false
                    this.noticeErrorShow = false

                    var vm = this

                    // é…ç½® axios ä½¿ç”¨ form
                    axios.defaults.headers.post['Content-Type'] = 'Content-Type:application/x-www-form-urlencoded; charset=UTF-8'

                    var params = new URLSearchParams();
                    params.append('name', this.name);
                    params.append('password', this.password);
                    if (this.notice.title != "") {
                        params.append("title", this.notice.title)
                    }
                    if (this.notice.content != "") {
                        params.append("content", this.notice.content)
                    }
                    if (this.notice.expired != "") {
                        params.append("expired", Date.parse(this.notice.expired) / 1000)    // Time in seconds since the Epoch. ä¸ python çš„ time.time() ä¿æŒä¸€è‡´
                    }
                    if (this.notice.audience != "") {
                        try {
                            params.append("audience", JSON.stringify(JSON.parse(this.notice.audience)))
                        } catch (e) {
                            this.noticeSuccessShow = false
                            this.noticeErrorText = 'æ‚¨å¡«å†™çš„â€œæŒ‡å®šæ¥æ”¶ç”¨æˆ·â€æ ¼å¼é”™è¯¯ï¼Œè¯·ä¿è¯ json æ ¼å¼çš„ uid åˆ—è¡¨ï¼Œä¾‹å¦‚ ["001", "003", "023"]'
                            this.noticeErrorShow = true
                            return
                        }
                    }

                    axios.post('/notice', params).then(function (response) {
                        if (response.data.response != undefined) {
                            if (response.data.response.success != undefined) {  // å‘å¸ƒæˆåŠŸ
                                vm.noticeErrorShow = false
                                vm.noticeErrorText = DEFAULT_NOTICE_ERROR_TEXT
                                vm.noticeSuccessShow = true
                                return
                            }
                        } else if (response.data.error != undefined) {
                            vm.noticeSuccessShow = false
                            switch (response.data.error.error) {
                                case "not_permitted":
                                    vm.noticeErrorText = "ç®¡ç†å‘˜æƒé™è®¤è¯æœªé€šè¿‡ï¼Œè¯·æ­£ç¡®å¡«å†™æ‚¨çš„ç®¡ç†å‘˜ç”¨æˆ·ååŠå¯†ç "
                                    break
                                default:
                                    vm.noticeErrorText = DEFAULT_NOTICE_ERROR_TEXT
                            }
                            vm.noticeErrorShow = true
                        }
                    });
                }
            }
        }
    })
</script>